{% extends 'layout.twig' %}
{% block content %}
<section class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <h2 class="text-2xl font-bold">{{ __(schema|capitalize)|e }}</h2>
    <div class="flex items-center gap-2">
      {# Saved views selector #}
      {% if views is defined and views|length > 0 %}
        <form method="get" action="{{ path|default(current_path())|e }}" class="flex items-center gap-2">
          <label for="view" class="sr-only">{{ __('Saved views')|e }}</label>
          <select id="view" name="view" class="select select-bordered" onchange="this.form.submit()">
            <option value="">{{ __('All items')|e }}</option>
            {% for v in views %}
              <option value="{{ v.id|e }}" {{ (currentViewId|default(0)) == (v.id|default(0)) ? 'selected' : '' }}>{{ v.name|e }}</option>
            {% endfor %}
          </select>
          {# preserve query if user switches views? keep none to adopt view defaults #}
        </form>
      {% endif %}

      {% include 'partials/dynamic_search.twig' with { path: path|default(current_path()), q: q|default(''), sort: sort|default('name'), dir: dir|default('asc'), extra: { tag: tag|default('') } } %}
      <a class="btn btn-primary" href="{{ url('/' ~ schema ~ '/new') }}">+ {{ __('Add '  ~ type)|e }}</a>
      {# Save current view button #}
      <form method="post" action="{{ url('/views/save') }}" class="flex items-center gap-2">
        {{ csrf_field()|raw }}
        <input type="hidden" name="entity" value="{{ schema|e }}">
        <input type="hidden" name="q" value="{{ q|default('')|e }}">
        <input type="hidden" name="tag" value="{{ tag|default('')|e }}">
        <input type="hidden" name="sort" value="{{ sort|default('name')|e }}">
        <input type="hidden" name="dir" value="{{ dir|default('asc')|e }}">
        <input type="hidden" name="per" value="{{ per|default(10)|e }}">
        <input type="hidden" name="return" value="{{ path|default(current_path())|e }}">
        <label class="input input-bordered flex items-center gap-2">
          <input type="text" name="name" placeholder="{{ __('View name')|e }}" class="grow" required>
        </label>
        <button class="btn" type="submit">{{ __('Save view')|e }}</button>
      </form>
    </div>
  </div>

  {% if columns is defined and columns %}
    {% include 'partials/dynamic_list.twig' with {
      title: '',
      items: items|default([]),
      columns: columns,
      path: path|default(current_path()),
      sort: sort|default('name'),
      dir: dir|default('asc'),
      q: q|default(''),
      tag: tag|default(''),
      per: per|default(10),
      actions: { view_url: url('/' ~ schema ~ '/view'), edit_url: url('/' ~ schema ~ '/edit'), delete_url: url('/' ~ schema ~ '/delete'), id_field: 'id' }
    } %}
    <div class="mt-4">
      {% set extra = {q: q|default(''), tag: tag|default(''), per: (per|default(10))|int} %}
      {{ paginate(total|default(items|length)|int, page|default(1)|int, per|default(10)|int, path|default(current_path()), extra|merge({sort: sort|default('name'), dir: dir|default('asc')}))|raw }}
    </div>
  {% endif %}
</section>
{% endblock %}