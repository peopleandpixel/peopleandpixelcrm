{% extends 'layout.twig' %}
{% block content %}
<h1>Import Result</h1>
<p>
  <strong>Entity:</strong> {{ entity|e }}<br>
  <strong>Format:</strong> {{ format|e }}<br>
  <strong>Dry-run:</strong> {{ dry_run ? 'Yes' : 'No' }}
</p>
<p>
  <strong>Total rows:</strong> {{ total|int }}<br>
  <strong>Valid:</strong> {{ valid_count|int }}<br>
  <strong>Invalid:</strong> {{ invalid_count|int }}
</p>
{% if unknown_fields is defined and unknown_fields|length > 0 %}
  <div class="alert alert-warning">
    Some rows contained unknown fields that were ignored:
    <ul>
      {% for idx, fields in unknown_fields %}
        <li>Row #{{ (idx + 1)|int }}: {{ fields|join(', ')|e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
{% if invalid_count > 0 %}
  <h2>Errors</h2>
  <ol>
  {% for item in invalid %}
    <li>
      <div><strong>Row #{{ (item.index + 1)|int }}</strong></div>
      <ul>
        {% for field, errs in item.errors %}
          {% for err in errs %}
            {% set msg = (attribute(err, 'key') is defined) ? __(err.key, attribute(err, 'params') is defined ? err.params : {}) : ((attribute(err, 'code') is defined) ? __('validation.' ~ err.code) : (attribute(err, 'message') is defined ? err.message : err)) %}
            <li>{{ field|e }}: {{ msg|e }} ({{ err.code|e }})</li>
          {% endfor %}
        {% endfor %}
      </ul>
      <details>
        <summary>Row data</summary>
        <pre>{{ item.data|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
      </details>
    </li>
  {% endfor %}
  </ol>
{% else %}
  {% if dry_run %}
    <h2>Dry-run Preview</h2>
    {% if actions is defined %}
      <ul>
        {% set c = 0 %}{% set u = 0 %}{% set m = 0 %}{% set s = 0 %}
        {% for a in actions %}
          {% if a.action == 'create' %}{% set c = c + 1 %}{% elseif a.action == 'update' %}{% set u = u + 1 %}{% elseif a.action == 'merge' %}{% set m = m + 1 %}{% else %}{% set s = s + 1 %}{% endif %}
          <li>Row #{{ (a.index + 1)|int }} → {{ a.action|e }}{% if a.id is defined %} (id={{ a.id }}){% endif %}{% if a.reason is defined %} – {{ a.reason|e }}{% endif %}</li>
        {% endfor %}
      </ul>
      <p><strong>Summary:</strong> Create {{ c }}, Update {{ u }}, Merge {{ m }}, Skip {{ s }}</p>
      <div class="alert">If this looks correct, go back and uncheck dry-run to execute.</div>
    {% endif %}
  {% else %}
    <div class="alert alert-success">Data imported successfully.</div>
  {% endif %}
{% endif %}
<p><a href="{{ url('/import') }}" class="btn">Back to Import</a></p>
{% endblock %}
