<!doctype html>
<html lang="{{ currentLang|default('en')|e }}" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ __('People & Pixel - Basic CRM')|e }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="canonical" href="{{ canonical_url() }}">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="{{ url('/manifest.webmanifest') }}">
    <link rel="icon" href="{{ url('/icons/app-icon.svg') }}" type="image/svg+xml">
    <link rel="apple-touch-icon" href="{{ url('/icons/app-icon.svg') }}">
    <!-- Tailwind CSS + DaisyUI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <!-- Custom overrides (optional) -->
    <link rel="stylesheet" href="{{ url('/style.css') }}">
</head>
<body class="min-h-screen bg-base-100 text-base-content">
{% include 'partials/header.twig' %}
<div id="main" class="container mx-auto p-4" tabindex="-1">
    {% include 'partials/flashes.twig' %}
    <div class="flex gap-4">
        <aside class="w-56 shrink-0">
            <nav class="menu bg-base-200 rounded-box" role="navigation" aria-label="{{ __('Primary')|e }}">
                <ul>
                    <li><a href="{{ url('/') }}" class="{{ active_class('/') ? 'active' : '' }}" {{ active_class('/') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'home', classes: 'w-5 h-5 mr-2' } %} {{ __('Home')|e }}</a></li>
                    {% if can('contacts','view') %}
                    <li><a href="{{ url('/contacts') }}" class="{{ active_class('/contacts') ? 'active' : '' }}" {{ active_class('/contacts') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'users', classes: 'w-5 h-5 mr-2' } %} {{ __('Contacts')|e }}</a></li>
                    <li><a href="{{ url('/contacts/dedupe') }}" class="{{ active_class('/contacts/dedupe') ? 'active' : '' }}">↳ {{ __('Find duplicates')|e }}</a></li>
                    {% endif %}
                    {% if can('tasks','view') %}<li><a href="{{ url('/tasks') }}" class="{{ active_class('/tasks') ? 'active' : '' }}" {{ active_class('/tasks') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'checklist', classes: 'w-5 h-5 mr-2' } %} {{ __('Tasks')|e }}</a></li>{% endif %}
                    {% if can('deals','view') %}<li><a href="{{ url('/deals') }}" class="{{ active_class('/deals') ? 'active' : '' }}" {{ active_class('/deals') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'chart-up', classes: 'w-5 h-5 mr-2' } %} {{ __('Deals')|e }}</a></li>{% endif %}
                    {% if can('projects','view') %}<li><a href="{{ url('/projects') }}" class="{{ active_class('/projects') ? 'active' : '' }}" {{ active_class('/projects') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'box', classes: 'w-5 h-5 mr-2' } %} {{ __('Projects')|e }}</a></li>{% endif %}
                    <li><a href="{{ url('/calendar') }}" class="{{ active_class('/calendar') ? 'active' : '' }}" {{ active_class('/calendar') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'calendar', classes: 'w-5 h-5 mr-2' } %} {{ __('Calendar')|e }}</a></li>
                    {% if can('reports','view') %}<li><a href="{{ url('/reports') }}" class="{{ active_class('/reports') ? 'active' : '' }}" {{ active_class('/reports') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'chart-pie', classes: 'w-5 h-5 mr-2' } %} {{ __('Reports')|e }}</a></li>{% endif %}
                    <li><a href="{{ url('/search') }}" class="{{ active_class('/search') ? 'active' : '' }}" {{ active_class('/search') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'search', classes: 'w-5 h-5 mr-2' } %} {{ __('Search')|e }}</a></li>

                    <li class="menu-title"><span>{{ __('More')|e }}</span></li>
                    {% if can('employees','view') %}<li><a href="{{ url('/employees') }}" class="{{ active_class('/employees') ? 'active' : '' }}" {{ active_class('/employees') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'briefcase', classes: 'w-5 h-5 mr-2' } %} {{ __('Employees')|e }}</a></li>{% endif %}
                    {% if can('times','view') %}<li><a href="{{ url('/times') }}" class="{{ active_class('/times') ? 'active' : '' }}" {{ active_class('/times') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'stopwatch', classes: 'w-5 h-5 mr-2' } %} {{ __('Working Times')|e }}</a></li>{% endif %}
                    {% if can('candidates','view') %}<li><a href="{{ url('/candidates') }}" class="{{ active_class('/candidates') ? 'active' : '' }}" {{ active_class('/candidates') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'magnet', classes: 'w-5 h-5 mr-2' } %} {{ __('Recruiting')|e }}</a></li>{% endif %}
                    {% if can('payments','view') %}<li><a href="{{ url('/payments') }}" class="{{ active_class('/payments') ? 'active' : '' }}" {{ active_class('/payments') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'credit-card', classes: 'w-5 h-5 mr-2' } %} {{ __('Payments')|e }}</a></li>{% endif %}
                    {% if can('storage','view') %}
                      <li><a href="{{ url('/storage') }}" class="{{ active_class('/storage') ? 'active' : '' }}" {{ active_class('/storage') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'archive', classes: 'w-5 h-5 mr-2' } %} {{ __('Storage')|e }}</a></li>
                      <li><a href="{{ url('/storage/history') }}" class="{{ active_class('/storage/history') ? 'active' : '' }}">↳ {{ __('Storage history')|e }}</a></li>
                    {% endif %}
                    <li class="menu-title"><span>{{ __('Data I/O')|e }}</span></li>
                    <li><a href="{{ url('/import') }}" class="{{ active_class('/import') ? 'active' : '' }}">{{ __('Import')|e }}</a></li>
                    <li class="px-4 py-1 text-xs text-base-content/60">{{ __('Export')|e }}</li>
                    <li><a href="{{ url('/export/contacts.csv') }}">↳ {{ __('Contacts CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/tasks.csv') }}">↳ {{ __('Tasks CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/times.csv') }}">↳ {{ __('Times CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/employees.csv') }}">↳ {{ __('Employees CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/candidates.csv') }}">↳ {{ __('Candidates CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/payments.csv') }}">↳ {{ __('Payments CSV')|e }}</a></li>
                    <li><a href="{{ url('/export/storage.csv') }}">↳ {{ __('Storage CSV')|e }}</a></li>

                    {% if is_admin() %}
                    <li class="menu-title"><span>{{ __('Administration')|e }}</span></li>
                    <li><a href="{{ url('/admin/users') }}" class="{{ active_class('/admin') ? 'active' : '' }}" {{ active_class('/admin') ? 'aria-current="page"' : '' }}>{{ __('Users')|e }}</a></li>
                    <li><a href="{{ url('/audit') }}" class="{{ active_class('/audit') ? 'active' : '' }}" {{ active_class('/audit') ? 'aria-current="page"' : '' }}>{{ __('Audit log')|e }}</a></li>
                    {% endif %}
                    <li class="mt-2 px-4 pb-3">
                        <label class="label" for="lang-select"><span class="label-text">{{ __('Language')|e }}</span></label>
                        <select id="lang-select" class="select select-bordered w-full max-w-xs" aria-label="{{ __('Language')|e }}">
                            {% set cl = currentLang|default('en') %}
                            <option value="en" {{ cl=='en' ? 'selected' : '' }}>EN</option>
                            <option value="de" {{ cl=='de' ? 'selected' : '' }}>DE</option>
                            <option value="pt" {{ cl=='pt' ? 'selected' : '' }}>PT</option>
                        </select>
                    </li>
                </ul>
            </nav>
        </aside>
        <main class="flex-1">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>
{% include 'partials/footer.twig' %}
<script>
(function(){
  // Language selector change handler
  const sel = document.getElementById('lang-select');
  if (sel){
    sel.addEventListener('change', function(){
      const value = this.value;
      try {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', value);
        window.location.href = url.toString();
      } catch (e) {
        const loc = window.location;
        const query = loc.search ? loc.search.substring(1) : '';
        const params = new URLSearchParams(query);
        params.set('lang', value);
        const q = params.toString();
        window.location.href = loc.pathname + (q ? ('?' + q) : '');
      }
    });
  }

  // Register Service Worker for offline-first
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      try { navigator.serviceWorker.register('{{ url('/sw.js') }}'); } catch(e) { /* ignore */ }
    });
  }

  // THEME: apply saved or preferred theme on load using DaisyUI data-theme
  const storageKey = 'pp.theme';
  const btn = document.getElementById('theme-toggle');
  function getStoredTheme(){
    try { return localStorage.getItem(storageKey); } catch(e){ return null; }
  }
  function storeTheme(t){ try { localStorage.setItem(storageKey, t); } catch(e){} }
  function systemPrefersDark(){
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }
  function applyTheme(theme){
    const t = theme || 'light';
    document.documentElement.setAttribute('data-theme', t);
    document.body.setAttribute('data-theme', t);
    if (btn){
      btn.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
      const icon = btn.querySelector('[data-icon]');
      if (icon){ icon.textContent = (t === 'dark') ? '🌙' : '☀️'; }
    }
  }
  let initial = getStoredTheme();
  if (!initial) { initial = systemPrefersDark() ? 'dark' : 'light'; }
  applyTheme(initial);
  if (btn){
    btn.addEventListener('click', function(ev){
      ev.preventDefault();
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      const next = (cur === 'dark') ? 'light' : 'dark';
      applyTheme(next);
      storeTheme(next);
      try {
        const live = document.getElementById('sr-live');
        if (live) live.textContent = (next === 'dark') ? 'Dark theme enabled' : 'Light theme enabled';
      } catch(e){}
    });
  }
  if (!getStoredTheme() && window.matchMedia) {
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    if (mq.addEventListener) mq.addEventListener('change', function(e){ applyTheme(e.matches ? 'dark' : 'light'); });
    else if (mq.addListener) mq.addListener(function(e){ applyTheme(e.matches ? 'dark' : 'light'); });
  }
})();
  
  // RUNNING TIMER indicator
  (function(){
    const header = document.getElementById('app-header');
    const badge = document.getElementById('running-timer');
    const timeEl = badge ? badge.querySelector('[data-time]') : null;
    let timer = null;
    let fetchIv = null;
    let startMs = null; // epoch ms
    let lastDocTitle = document.title;

    function fmt(n){ return n < 10 ? '0' + n : '' + n; }
    function render(){
      if (!badge || startMs == null) return;
      const now = Date.now();
      let diff = Math.max(0, Math.floor((now - startMs) / 1000));
      const h = Math.floor(diff / 3600); diff -= h*3600;
      const m = Math.floor(diff / 60); const s = diff - m*60;
      const text = fmt(h) + ':' + fmt(m) + ':' + fmt(s);
      if (timeEl) timeEl.textContent = text;
      document.title = '⏱ ' + text + ' — ' + (lastDocTitle || '');
    }
    function setActive(on){
      if (!header || !badge) return;
      if (on){
        badge.classList.remove('hidden');
        // subtle animation on the navbar
        header.classList.add('animate-pulse');
      } else {
        badge.classList.add('hidden');
        header.classList.remove('animate-pulse');
        if (timer){ clearInterval(timer); timer = null; }
        document.title = lastDocTitle;
      }
    }
    async function check(){
      try {
        const res = await fetch('{{ url('/times/running') }}', { headers: { 'Accept': 'application/json' } });
        const json = await res.json().catch(() => null);
        if (!json || !json.ok){ throw new Error('bad'); }
        const r = json.running;
        if (!r){
          startMs = null;
          setActive(false);
          return;
        }
        // Prefer iso_start if provided
        let iso = r.iso_start;
        if (!iso && r.date && r.start_time){
          const st = r.start_time;
          iso = r.date + 'T' + (st && st.length === 5 ? (st + ':00') : st);
        }
        const start = Date.parse(iso);
        if (isNaN(start)){
          startMs = null; setActive(false); return;
        }
        if (startMs == null || Math.abs(startMs - start) > 1000){
          startMs = start; lastDocTitle = lastDocTitle || document.title; setActive(true);
          const sr = document.getElementById('sr-live'); if (sr) { sr.textContent = 'Timer started'; }
          // Try to show a local notification when timer starts
          if (window.ppNotify) {
            window.ppNotify('Timer started', { body: 'Your working timer is now running.', icon: '/website/img/placeholder-16x9.svg', badge: '/website/img/placeholder-16x9.svg' });
          }
        }
        if (!timer){ timer = setInterval(render, 1000); }
        render();
      } catch(e){ /* ignore transient errors */ }
    }
    // Initial and periodic checks
    check();
    fetchIv = setInterval(check, 15000);
    // If page becomes visible again, refresh immediately
    document.addEventListener('visibilitychange', function(){ if (!document.hidden) check(); });
  })();
</script>
<script>
// Register service worker for PWA
(function(){
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('{{ url('/sw.js') }}').catch(function(){ /* ignore */ });
    });
  }
  // Notifications helper used by timer code
  window.ppNotify = function(title, options){
    try{
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(p){ if (p !== 'granted') return; window.ppNotify(title, options); });
        return;
      }
      if (Notification.permission !== 'granted') return;
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'notify', title: title, options: options || {} });
      } else if (navigator.serviceWorker) {
        navigator.serviceWorker.getRegistration().then(function(reg){ if (reg && reg.showNotification) reg.showNotification(title || 'Notification', options || {}); });
      }
    } catch(e) { /* ignore */ }
  };
})();
</script>
<script>
// Accessibility: focus search on '/'
(function(){
  document.addEventListener('keydown', function(e){
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      var el = document.querySelector('input[name="q"]');
      if (el) { e.preventDefault(); el.focus(); try{ el.select(); }catch(_){} }
    }
  });
})();
</script>
</body>
</html>
