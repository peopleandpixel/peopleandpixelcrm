<!doctype html>
<html lang="{{ currentLang|default('en')|e }}" data-theme="light">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ __('People & Pixel - Basic CRM')|e }}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="canonical" href="{{ canonical_url() }}">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="{{ url('/manifest.webmanifest') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="People & Pixel">
    <link rel="icon" href="{{ url('/icons/app-icon.svg') }}" type="image/svg+xml">
    <link rel="apple-touch-icon" href="{{ url('/icons/app-icon.svg') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <link id="daisyui-css" href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script>
      // Runtime fallback: if DaisyUI failed to load from jsDelivr, try unpkg mirror
      (function(){
        function ready(fn){ if (document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
        function hasDaisy(){
          try {
            var el = document.createElement('button');
            el.className = 'btn';
            el.style.position = 'absolute'; el.style.left = '-9999px';
            document.body.appendChild(el);
            var cs = window.getComputedStyle(el);
            var pad = parseFloat(cs.paddingLeft) || 0;
            var rad = (cs.borderRadius || '0px');
            document.body.removeChild(el);
            return pad > 8 && rad !== '0px';
          } catch(e){ return false; }
        }
        function injectFallback(){
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://unpkg.com/daisyui@4.12.10/dist/full.min.css';
          link.crossOrigin = 'anonymous';
          document.head.appendChild(link);
        }
        function injectLocal(){
          var link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = '{{ url('/vendor/daisyui.min.css') }}';
          document.head.appendChild(link);
        }
        ready(function(){
          // wait a tick to allow primary CSS to apply
          setTimeout(function(){
            if (!hasDaisy()) {
              injectFallback();
              // Try mirror; if still missing, try local lightweight fallback; finally enable minimal emergency styles
              setTimeout(function(){
                if (!hasDaisy()) {
                  injectLocal();
                  setTimeout(function(){ if (!hasDaisy()) { try { document.documentElement.classList.add('no-daisyui'); } catch(_){} } }, 800);
                }
              }, 800);
            }
          }, 600);
        });
      })();
    </script>
    <!-- Custom overrides (optional) -->
    <link rel="stylesheet" href="{{ url('/style.css') }}">
</head>
<body class="min-h-screen bg-base-100 text-base-content">
{% include 'partials/header.twig' %}
<div id="main" class="container mx-auto p-4" tabindex="-1">
    {% include 'partials/flashes.twig' %}
    <div class="flex gap-4">
        <aside class="w-56 shrink-0">
            <nav class="menu bg-base-200 rounded-box" role="navigation" aria-label="{{ __('Primary')|e }}">
                <ul>
                    <li><a href="{{ url('/') }}" class="{{ active_class('/') ? 'active' : '' }}" {{ active_class('/') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'home', classes: 'w-5 h-5 mr-2' } %} {{ __('Home')|e }}</a></li>
                    {% if can('contacts','view') %}
                    <li>
                      <details {{ (active_class('/contacts') or active_class('/contacts/dedupe')) ? 'open' : '' }}>
                        <summary>
                          <span class="inline-flex items-center">
                            {% include 'partials/icon.twig' with { name: 'users', classes: 'w-5 h-5 mr-2' } %}
                            {{ __('Contacts')|e }}
                          </span>
                        </summary>
                        <ul>
                          <li>
                            <a href="{{ url('/contacts') }}" class="{{ active_class('/contacts') ? 'active' : '' }}" {{ active_class('/contacts') ? 'aria-current=\"page\"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'users', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('All Contacts')|e }}
                            </a>
                          </li>
                          <li>
                            <a href="{{ url('/contacts/dedupe') }}" class="{{ active_class('/contacts/dedupe') ? 'active' : '' }}" {{ active_class('/contacts/dedupe') ? 'aria-current=\"page\"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'search', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Find duplicates')|e }}
                            </a>
                          </li>
                        </ul>
                      </details>
                    </li>
                    {% endif %}
                    {% if can('tasks','view') %}<li><a href="{{ url('/tasks') }}" class="{{ active_class('/tasks') ? 'active' : '' }}" {{ active_class('/tasks') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'checklist', classes: 'w-5 h-5 mr-2' } %} {{ __('Tasks')|e }}</a></li>{% endif %}
                    {% if can('deals','view') %}<li><a href="{{ url('/deals') }}" class="{{ active_class('/deals') ? 'active' : '' }}" {{ active_class('/deals') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'chart-up', classes: 'w-5 h-5 mr-2' } %} {{ __('Deals')|e }}</a></li>{% endif %}
                    {% if can('projects','view') %}<li><a href="{{ url('/projects') }}" class="{{ active_class('/projects') ? 'active' : '' }}" {{ active_class('/projects') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'box', classes: 'w-5 h-5 mr-2' } %} {{ __('Projects')|e }}</a></li>{% endif %}
                    {% if can_url('/calendar') %}<li><a href="{{ url('/calendar') }}" class="{{ active_class('/calendar') ? 'active' : '' }}" {{ active_class('/calendar') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'calendar', classes: 'w-5 h-5 mr-2' } %} {{ __('Calendar')|e }}</a></li>{% endif %}
                    {% if can('reports','view') %}<li><a href="{{ url('/reports') }}" class="{{ active_class('/reports') ? 'active' : '' }}" {{ active_class('/reports') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'chart-pie', classes: 'w-5 h-5 mr-2' } %} {{ __('Reports')|e }}</a></li>{% endif %}
                    {% if can_url('/search') %}<li><a href="{{ url('/search') }}" class="{{ active_class('/search') ? 'active' : '' }}" {{ active_class('/search') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'search', classes: 'w-5 h-5 mr-2' } %} {{ __('Search')|e }}</a></li>{% endif %}
                    {% if can_url('/email') %}<li><a href="{{ url('/email') }}" class="{{ active_class('/email') ? 'active' : '' }}" {{ active_class('/email') ? 'aria-current="page"' : '' }}>{% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %} {{ __('Mail')|e }}</a></li>{% endif %}

                    {% set moreOpen =
                      active_class('/employees') or active_class('/times') or active_class('/candidates') or active_class('/payments') or active_class('/documents') or
                      active_class('/storage') or active_class('/storage/history') or active_class('/import') or active_class('/export') or
                      active_class('/admin') or active_class('/audit')
                    %}
                    <li>
                      <details {{ moreOpen ? 'open' : '' }}>
                        <summary>
                          <span class="inline-flex items-center">
                            {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                            {{ __('More')|e }}
                          </span>
                        </summary>
                        <ul>
                          {% if can('employees','view') %}
                          <li>
                            <a href="{{ url('/employees') }}" class="{{ active_class('/employees') ? 'active' : '' }}" {{ active_class('/employees') ? 'aria-current="page"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'briefcase', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Employees')|e }}
                            </a>
                          </li>
                          {% endif %}
                          {% if can('times','view') %}
                          <li>
                            <a href="{{ url('/times') }}" class="{{ active_class('/times') ? 'active' : '' }}" {{ active_class('/times') ? 'aria-current="page"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'stopwatch', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Working Times')|e }}
                            </a>
                          </li>
                          {% endif %}
                          {% if can('candidates','view') %}
                          <li>
                            <a href="{{ url('/candidates') }}" class="{{ active_class('/candidates') ? 'active' : '' }}" {{ active_class('/candidates') ? 'aria-current="page"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'magnet', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Recruiting')|e }}
                            </a>
                          </li>
                          {% endif %}
                          {% if can('payments','view') %}
                          <li>
                            <a href="{{ url('/payments') }}" class="{{ active_class('/payments') ? 'active' : '' }}" {{ active_class('/payments') ? 'aria-current="page"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'credit-card', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Payments')|e }}
                            </a>
                          </li>
                          {% endif %}
                          {% if can('documents','view') %}
                          <li>
                            <a href="{{ url('/documents') }}" class="{{ active_class('/documents') ? 'active' : '' }}" {{ active_class('/documents') ? 'aria-current="page"' : '' }}>
                              {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                              {{ __('Documents')|e }}
                            </a>
                          </li>
                          {% endif %}
                          {% if can('storage','view') %}
                          <li>
                            <details {{ (active_class('/storage') or active_class('/storage/history')) ? 'open' : '' }}>
                              <summary>
                                <a href="{{ url('/storage') }}" class="{{ active_class('/storage') ? 'active' : '' }}" {{ active_class('/storage') ? 'aria-current="page"' : '' }}>
                                  {% include 'partials/icon.twig' with { name: 'archive', classes: 'w-5 h-5 mr-2' } %}
                                  {{ __('Storage')|e }}
                                </a>
                              </summary>
                              <ul>
                                <li>
                                  <a href="{{ url('/storage/history') }}" class="{{ active_class('/storage/history') ? 'active' : '' }}" {{ active_class('/storage/history') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'archive', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Storage history')|e }}
                                  </a>
                                </li>
                              </ul>
                            </details>
                          </li>
                          {% endif %}
                          <li>
                            <details {{ (active_class('/import') or active_class('/export')) ? 'open' : '' }}>
                              <summary>
                                <span class="inline-flex items-center">
                                  {% include 'partials/icon.twig' with { name: 'archive', classes: 'w-5 h-5 mr-2' } %}
                                  {{ __('Data I/O')|e }}
                                </span>
                              </summary>
                              <ul>
                                <li>
                                  <a href="{{ url('/import') }}" class="{{ active_class('/import') ? 'active' : '' }}" {{ active_class('/import') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Import')|e }}
                                  </a>
                                </li>
                                <li class="px-4 py-1 text-xs text-base-content/60">{{ __('Export')|e }}</li>
                                <li>
                                  <a href="{{ url('/export/contacts.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Contacts CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/tasks.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Tasks CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/times.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Times CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/employees.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Employees CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/candidates.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Candidates CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/payments.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Payments CSV')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/export/storage.csv') }}">
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Storage CSV')|e }}
                                  </a>
                                </li>
                              </ul>
                            </details>
                          </li>

                          {% if is_admin() %}
                          <li>
                            <details {{ (active_class('/admin') or active_class('/audit')) ? 'open' : '' }}>
                              <summary>
                                <span class="inline-flex items-center">
                                  {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                  {{ __('Administration')|e }}
                                </span>
                              </summary>
                              <ul>
                                <li>
                                  <a href="{{ url('/admin/health') }}" class="{{ active_class('/admin/health') ? 'active' : '' }}" {{ active_class('/admin/health') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Health')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/admin/logs') }}" class="{{ active_class('/admin/logs') ? 'active' : '' }}" {{ active_class('/admin/logs') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Logs')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/admin/backups') }}" class="{{ active_class('/admin/backups') ? 'active' : '' }}" {{ active_class('/admin/backups') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'archive', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Backups')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/admin/users') }}" class="{{ active_class('/admin/users') ? 'active' : '' }}" {{ active_class('/admin/users') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'users', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Users')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/admin/settings') }}" class="{{ active_class('/admin/settings') ? 'active' : '' }}" {{ active_class('/admin/settings') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Settings')|e }}
                                  </a>
                                </li>
                                <li>
                                  <a href="{{ url('/audit') }}" class="{{ active_class('/audit') ? 'active' : '' }}" {{ active_class('/audit') ? 'aria-current="page"' : '' }}>
                                    {% include 'partials/icon.twig' with { name: 'file', classes: 'w-5 h-5 mr-2' } %}
                                    {{ __('Audit log')|e }}
                                  </a>
                                </li>
                              </ul>
                            </details>
                          </li>
                          {% endif %}
                        </ul>
                      </details>
                    </li>
                    <li class="mt-2 px-4 pb-3">
                        <label class="label" for="lang-select"><span class="label-text">{{ __('Language')|e }}</span></label>
                        <select id="lang-select" class="select select-bordered w-full max-w-xs" aria-label="{{ __('Language')|e }}">
                            {% set cl = currentLang|default('en') %}
                            <option value="en" {{ cl=='en' ? 'selected' : '' }}>EN</option>
                            <option value="de" {{ cl=='de' ? 'selected' : '' }}>DE</option>
                            <option value="pt" {{ cl=='pt' ? 'selected' : '' }}>PT</option>
                        </select>
                    </li>
                </ul>
            </nav>
        </aside>
        <main class="flex-1">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>
{% include 'partials/footer.twig' %}

<!-- Install banner -->
<div id="install-banner" class="fixed inset-x-0 bottom-0 z-40 hidden">
  <div class="mx-auto max-w-3xl px-4 pb-4">
    <div class="alert shadow-lg bg-base-200">
      <span>{{ __('Install People & Pixel for a faster, app-like experience.')|e }}</span>
      <div>
        <button id="install-dismiss" class="btn btn-ghost btn-sm mr-2" type="button" aria-label="{{ __('Dismiss')|e }}">{{ __('Not now')|e }}</button>
        <button id="install-accept" class="btn btn-primary btn-sm" type="button">{{ __('Install')|e }}</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // Language selector change handler
  const sel = document.getElementById('lang-select');
  if (sel){
    sel.addEventListener('change', function(){
      const value = this.value;
      try {
        const url = new URL(window.location.href);
        url.searchParams.set('lang', value);
        window.location.href = url.toString();
      } catch (e) {
        const loc = window.location;
        const query = loc.search ? loc.search.substring(1) : '';
        const params = new URLSearchParams(query);
        params.set('lang', value);
        const q = params.toString();
        window.location.href = loc.pathname + (q ? ('?' + q) : '');
      }
    });
  }

  // Register Service Worker for offline-first
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      try { navigator.serviceWorker.register('{{ url('/sw.js') }}'); } catch(e) { /* ignore */ }
    });
  }

  // A2HS Install prompt UX
  (function(){
    var deferred; // beforeinstallprompt event
    var banner = document.getElementById('install-banner');
    var acceptBtn = document.getElementById('install-accept');
    var dismissBtn = document.getElementById('install-dismiss');
    var storageKey = 'pp.install.dismissedAt';

    function isStandalone(){
      return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
    }
    function show(){ if (banner) banner.classList.remove('hidden'); }
    function hide(){ if (banner) banner.classList.add('hidden'); }
    function recentlyDismissed(){
      try { var t = parseInt(localStorage.getItem(storageKey)||'0',10); return Date.now() - t < 7*24*3600*1000; } catch(e){ return false; }
    }

    window.addEventListener('beforeinstallprompt', function(e){
      // Chrome/Edge will fire this when installable
      e.preventDefault();
      deferred = e;
      if (!isStandalone() && !recentlyDismissed()) { show(); }
    });
    window.addEventListener('appinstalled', function(){ hide(); deferred = null; try{ localStorage.removeItem(storageKey); }catch(e){} });

    if (acceptBtn) acceptBtn.addEventListener('click', function(){
      if (!deferred) { hide(); return; }
      deferred.prompt();
      deferred.userChoice.then(function(){ hide(); deferred = null; });
    });
    if (dismissBtn) dismissBtn.addEventListener('click', function(){ hide(); try{ localStorage.setItem(storageKey, String(Date.now())); }catch(e){} });

    // iOS Safari doesnâ€™t support beforeinstallprompt; show guidance if eligible
    var isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
    if (isIOS && !isStandalone() && !recentlyDismissed()) {
      // Delay slightly to avoid flashing on every page load
      setTimeout(function(){ show(); }, 1200);
      if (acceptBtn) acceptBtn.textContent = '{{ __('How to install')|e }}';
      if (acceptBtn) acceptBtn.addEventListener('click', function(){
        alert('To install: tap the Share button in Safari, then "Add to Home Screen".');
        hide();
      });
    }
  })();

  // THEME: apply saved or preferred theme on load using DaisyUI data-theme
  const storageKey = 'pp.theme';
  const btn = document.getElementById('theme-toggle');
  function getStoredTheme(){
    try { return localStorage.getItem(storageKey); } catch(e){ return null; }
  }
  function storeTheme(t){ try { localStorage.setItem(storageKey, t); } catch(e){} }
  function systemPrefersDark(){
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  }
  function applyTheme(theme){
    const t = theme || 'light';
    document.documentElement.setAttribute('data-theme', t);
    document.body.setAttribute('data-theme', t);
    if (btn){
      btn.setAttribute('aria-pressed', t === 'dark' ? 'true' : 'false');
      const icon = btn.querySelector('[data-icon]');
      if (icon){ icon.textContent = (t === 'dark') ? 'ðŸŒ™' : 'â˜€ï¸'; }
    }
  }
  let initial = getStoredTheme();
  if (!initial) { initial = systemPrefersDark() ? 'dark' : 'light'; }
  applyTheme(initial);
  if (btn){
    btn.addEventListener('click', function(ev){
      ev.preventDefault();
      const cur = document.documentElement.getAttribute('data-theme') || 'light';
      const next = (cur === 'dark') ? 'light' : 'dark';
      applyTheme(next);
      storeTheme(next);
      try {
        const live = document.getElementById('sr-live');
        if (live) live.textContent = (next === 'dark') ? 'Dark theme enabled' : 'Light theme enabled';
      } catch(e){}
    });
  }
  if (!getStoredTheme() && window.matchMedia) {
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    if (mq.addEventListener) mq.addEventListener('change', function(e){ applyTheme(e.matches ? 'dark' : 'light'); });
    else if (mq.addListener) mq.addListener(function(e){ applyTheme(e.matches ? 'dark' : 'light'); });
  }
})();
  
  // RUNNING TIMER indicator
  (function(){
    const header = document.getElementById('app-header');
    const badge = document.getElementById('running-timer');
    const timeEl = badge ? badge.querySelector('[data-time]') : null;
    let timer = null;
    let fetchIv = null;
    let startMs = null; // epoch ms
    let lastDocTitle = document.title;

    function fmt(n){ return n < 10 ? '0' + n : '' + n; }
    function render(){
      if (!badge || startMs == null) return;
      const now = Date.now();
      let diff = Math.max(0, Math.floor((now - startMs) / 1000));
      const h = Math.floor(diff / 3600); diff -= h*3600;
      const m = Math.floor(diff / 60); const s = diff - m*60;
      const text = fmt(h) + ':' + fmt(m) + ':' + fmt(s);
      if (timeEl) timeEl.textContent = text;
      document.title = 'â± ' + text + ' â€” ' + (lastDocTitle || '');
    }
    function setActive(on){
      if (!header || !badge) return;
      if (on){
        badge.classList.remove('hidden');
        // subtle animation on the navbar
        header.classList.add('animate-pulse');
      } else {
        badge.classList.add('hidden');
        header.classList.remove('animate-pulse');
        if (timer){ clearInterval(timer); timer = null; }
        document.title = lastDocTitle;
      }
    }
    async function check(){
      try {
        const res = await fetch('{{ url('/times/running') }}', { headers: { 'Accept': 'application/json' } });
        const json = await res.json().catch(() => null);
        if (!json || !json.ok){ throw new Error('bad'); }
        const r = json.running;
        if (!r){
          startMs = null;
          setActive(false);
          return;
        }
        // Prefer iso_start if provided
        let iso = r.iso_start;
        if (!iso && r.date && r.start_time){
          const st = r.start_time;
          iso = r.date + 'T' + (st && st.length === 5 ? (st + ':00') : st);
        }
        const start = Date.parse(iso);
        if (isNaN(start)){
          startMs = null; setActive(false); return;
        }
        if (startMs == null || Math.abs(startMs - start) > 1000){
          startMs = start; lastDocTitle = lastDocTitle || document.title; setActive(true);
          const sr = document.getElementById('sr-live'); if (sr) { sr.textContent = 'Timer started'; }
          // Try to show a local notification when timer starts
          if (window.ppNotify) {
            window.ppNotify('Timer started', { body: 'Your working timer is now running.', icon: '/website/img/placeholder-16x9.svg', badge: '/website/img/placeholder-16x9.svg' });
          }
        }
        if (!timer){ timer = setInterval(render, 1000); }
        render();
      } catch(e){ /* ignore transient errors */ }
    }
    // Initial and periodic checks
    check();
    fetchIv = setInterval(check, 15000);
    // If page becomes visible again, refresh immediately
    document.addEventListener('visibilitychange', function(){ if (!document.hidden) check(); });
  })();
</script>
<script>
// Register service worker for PWA
(function(){
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function(){
      navigator.serviceWorker.register('{{ url('/sw.js') }}').catch(function(){ /* ignore */ });
    });
  }
  // Notifications helper used by timer code
  window.ppNotify = function(title, options){
    try{
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') {
        Notification.requestPermission().then(function(p){ if (p !== 'granted') return; window.ppNotify(title, options); });
        return;
      }
      if (Notification.permission !== 'granted') return;
      if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage({ type: 'notify', title: title, options: options || {} });
      } else if (navigator.serviceWorker) {
        navigator.serviceWorker.getRegistration().then(function(reg){ if (reg && reg.showNotification) reg.showNotification(title || 'Notification', options || {}); });
      }
    } catch(e) { /* ignore */ }
  };
})();
</script>
<script>
// Accessibility: focus search on '/'
(function(){
  document.addEventListener('keydown', function(e){
    if (e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
      var el = document.querySelector('input[name="q"]');
      if (el) { e.preventDefault(); el.focus(); try{ el.select(); }catch(_){} }
    }
  });
})();
</script>
</body>
</html>
