{% extends 'layout.twig' %}
{% block content %}
<section class="space-y-6">
  <h2 class="text-2xl font-bold">{{ action == 'edit' ? __('Edit User')|e : __('Create User')|e }}</h2>
  <form class="space-y-4" method="post" action="{{ action == 'edit' ? url('/admin/users/edit') : url('/admin/users/new') }}">
    {{ csrf_field()|raw }}
    {% if user.id %}<input type="hidden" name="id" value="{{ user.id|e }}">{% endif %}

    <div class="form-control">
      <label class="label"><span class="label-text">{{ __('Login')|e }}</span></label>
      <input class="input input-bordered" type="text" name="login" value="{{ user.login|e }}" required>
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text">{{ __('Full name')|e }}</span></label>
      <input class="input input-bordered" type="text" name="fullname" value="{{ user.fullname|e }}">
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text">{{ __('Email')|e }}</span></label>
      <input class="input input-bordered" type="email" name="email" value="{{ user.email|e }}">
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text">{{ __('Role')|e }}</span></label>
      <select class="select select-bordered" name="role">
        {% set role = user.role|default('user') %}
        <option value="user" {{ role=='user'?'selected':'' }}>{{ __('User')|e }}</option>
        <option value="viewer" {{ role=='viewer'?'selected':'' }}>{{ __('Viewer')|e }}</option>
        <option value="admin" {{ role=='admin'?'selected':'' }}>{{ __('Admin')|e }}</option>
      </select>
    </div>
    <div class="form-control">
      <label class="label"><span class="label-text">{{ __('Password')|e }}</span></label>
      <input class="input input-bordered" type="password" name="password" value="">
      {% if action=='edit' %}<small class="text-xs opacity-70">{{ __('Leave empty to keep current password')|e }}</small>{% endif %}
    </div>

    {% set entities = ['contacts','times','tasks','employees','candidates','payments','storage'] %}
    <h3 class="text-xl font-semibold">{{ __('Permissions')|e }}</h3>
    <div class="overflow-x-auto">
      <table class="table table-zebra">
        <thead>
          <tr>
            <th rowspan="2">{{ __('Entity')|e }}</th>
            <th colspan="4" class="text-center">{{ __('Own')|e }}</th>
            <th colspan="4" class="text-center">{{ __('Others')|e }}</th>
          </tr>
          <tr>
            <th>{{ __('View')|e }}</th>
            <th>{{ __('Create')|e }}</th>
            <th>{{ __('Edit')|e }}</th>
            <th>{{ __('Delete')|e }}</th>
            <th>{{ __('View')|e }}</th>
            <th>{{ __('Create')|e }}</th>
            <th>{{ __('Edit')|e }}</th>
            <th>{{ __('Delete')|e }}</th>
          </tr>
        </thead>
        <tbody>
          {% for e in entities %}
            {% set p = user.permissions[e]|default({}) %}
            <tr>
              <td>{{ e|capitalize|e }}</td>
              {# Own #}
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][own][view]" value="1" {{ (p.own.view|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][own][create]" value="1" {{ (p.own.create|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][own][edit]" value="1" {{ (p.own.edit|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][own][delete]" value="1" {{ (p.own.delete|default(0)) ? 'checked' : '' }}></td>
              {# Others #}
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][others][view]" value="1" {{ (p.others.view|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][others][create]" value="1" {{ (p.others.create|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][others][edit]" value="1" {{ (p.others.edit|default(0)) ? 'checked' : '' }}></td>
              <td><input class="checkbox" type="checkbox" name="perm[{{e}}][others][delete]" value="1" {{ (p.others.delete|default(0)) ? 'checked' : '' }}></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="flex gap-2">
      <button class="btn btn-primary" type="submit">{{ __('Save')|e }}</button>
      <a class="btn" href="{{ url('/admin/users') }}">{{ __('Cancel')|e }}</a>
    </div>
  </form>
</section>
{% endblock %}
