{# Generic entity view renderer.
 Expects:
 - title (optional)
 - fields: array of {name,label}
 - data: associative array for the entity
 - back_url: URL for back navigation
#}
<section class="ui segment">
  {% if title is defined and title %}<h2 class="ui header">{{ title|e }}</h2>{% endif %}

  {% if data.picture is defined and data.picture %}
    <div class="ui small left floated image" style="margin-right:1rem;">
      <img src="{{ data.picture|e }}" alt="" style="max-width:160px; border-radius:6px;">
    </div>
  {% endif %}

  <div class="ui relaxed divided list">
    {# If fields provided, render in that order; otherwise iterate over data keys #}
    {% set entries = [] %}
    {% if fields is defined and fields %}
      {% set entries = fields %}
    {% else %}
      {% for k,v in data %}
        {% set entries = entries|merge([{ name: k, label: k }]) %}
      {% endfor %}
    {% endif %}

    {% for f in entries %}
      {% set fname = f.name %}
      {% set flabel = f.label|default(fname) %}
      {% if fname in ['id'] %}{# show id too #}{% endif %}
      {% set val = attribute(data, fname)|default(null) %}
      {% if val is not null and val is not same as(false) and val != '' %}
        <div class="item">
          <div class="content">
            <div class="header" style="margin-bottom:.25rem;">{{ flabel|e }}</div>
            <div class="description">
              {# Render arrays as bulleted lists; objects/assoc arrays as key: value pairs #}
              {% if val is iterable and val is not same as('') %}
                {% if val|length == 0 %}
                  <span class="muted">—</span>
                {% else %}
                  <div class="ui list">
                    {% for row in val %}
                      <div class="item">
                        {% if row is iterable %}
                          {# Try common patterns for contacts arrays #}
                          {% if row.value is defined %}
                            {% set bits = [] %}
                            {% if row.kind is defined and row.kind %}{% set bits = bits|merge([row.kind]) %}{% endif %}
                            {% if row.tag is defined and row.tag %}{% set bits = bits|merge([row.tag]) %}{% endif %}
                            {% if bits %}<span class="ui tiny label">{{ bits|join(' • ')|e }}</span> {% endif %}
                            {% set v = row.value %}
                            {% if v starts with 'http://' or v starts with 'https://' %}
                              <a href="{{ v|e }}" target="_blank" rel="noopener">{{ v|e }}</a>
                            {% else %}
                              {{ v|e }}
                            {% endif %}
                          {% else %}
                            {{ row|json_encode(constant('JSON_UNESCAPED_UNICODE'))|e }}
                          {% endif %}
                        {% else %}
                          {{ row|e }}
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% else %}
                {% set text = val %}
                {% if text starts with 'http://' or text starts with 'https://' %}
                  <a href="{{ text|e }}" target="_blank" rel="noopener">{{ text|e }}</a>
                {% else %}
                  {{ text|e }}
                {% endif %}
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div class="ui divider"></div>
  <div class="ui buttons">
    {% if back_url %}
      <a class="ui button" href="{{ back_url }}">← {{ __('Back')|e }}</a>
    {% endif %}
    {% if edit_url is defined and edit_url %}
      <a class="ui primary button" href="{{ edit_url }}">{{ __('Edit')|e }}</a>
    {% endif %}
  </div>
</section>
