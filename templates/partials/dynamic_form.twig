{# Generic dynamic form renderer. Expects:
 - title (optional)
 - form_action (optional)
 - submit_label (optional)
 - fields: array of {name,label,type,required,options?,placeholder?,rows?}
 - data: associative array with values (e.g., entity data)
 - cancel_url: URL to go back
#}
<section class="space-y-6">
    <h2 class="text-2xl font-semibold">{{ title|default('')|e }}</h2>
    {# Determine if we need multipart form (file upload). If any field has type 'file' or field name is 'picture', enable it. #}
    {% set hasFile = false %}
    {% for f in fields %}
        {% if (f.type is defined and f.type == 'file') or (f.name is defined and f.name == 'picture') %}
            {% set hasFile = true %}
        {% endif %}
    {% endfor %}

    {# Heuristic grouping and ordering of fields by type/name #}
    {% set primaryNames = ['title','name','subject','company','project','deal'] %}
    {% set statusNames  = ['status','stage','phase','priority'] %}
    {% set idNames      = ['code','slug'] %}
    {% set moneyNames   = ['amount','budget','price','cost','rate','value'] %}
    {% set contactNames = ['email','emails','emails_text','phone','phones','phones_text','website','websites','websites_text','socials','socials_text','address'] %}
    {% set dateHints    = ['date','_at','due','start','end','birth'] %}
    {% set textNames    = ['description','notes','comment','comments','summary'] %}

    {% set prim = [] %}
    {% set status = [] %}
    {% set ids = [] %}
    {% set media = [] %}
    {% set money = [] %}
    {% set contacts = [] %}
    {% set dates = [] %}
    {% set texts = [] %}
    {% set others = [] %}

    {% for f in fields %}
        {% set n = (f.name|default('')) %}
        {% set t = (f.type|default('text')) %}
        {% set lname = n|lower %}
        {% if lname in primaryNames %}
            {% set prim = prim|merge([f]) %}
        {% elseif lname in statusNames %}
            {% set status = status|merge([f]) %}
        {% elseif lname in idNames or lname == 'id' %}
            {% set ids = ids|merge([f]) %}
        {% elseif lname in contactNames %}
            {% set contacts = contacts|merge([f]) %}
        {% elseif t == 'file' or lname in ['picture','avatar','image','logo'] %}
            {% set media = media|merge([f]) %}
        {% elseif lname in moneyNames %}
            {% set money = money|merge([f]) %}
        {% elseif (dateHints|filter(h => h in lname))|length > 0 or t in ['date','datetime-local','time'] %}
            {% set dates = dates|merge([f]) %}
        {% elseif lname in textNames or t == 'textarea' %}
            {% set texts = texts|merge([f]) %}
        {% else %}
            {% set others = others|merge([f]) %}
        {% endif %}
    {% endfor %}
    {% set ordered = prim|merge(status)|merge(ids)|merge(media)|merge(money)|merge(contacts)|merge(dates)|merge(others)|merge(texts) %}

    <form method="post" class="space-y-6"{% if form_action is defined and form_action %} action="{{ form_action }}"{% endif %}{% if hasFile %} enctype="multipart/form-data"{% endif %}>
        {{ csrf_field()|raw }}
        {% if error is defined and error %}
            <div class="alert alert-error"><span>{{ error|e }}</span></div>
        {% endif %}
        {% if data.id is defined and data.id %}
            <input type="hidden" name="id" value="{{ (data.id)|int }}">
        {% endif %}

        {# Render sections: Primary, Status, Media, Money & Numbers, Contacts & Links, Dates, Other, Notes #}
        {% macro render_field(f, data, errors) %}
            {% import _self as self %}
            {% set fname = f.name %}
            {% set ftype = f.type|default('text') %}
            {% set flabel = f.label|default(fname)|e %}
            {% set fval = attribute(data, fname)|default('') %}
            {% set ferr = (errors is defined) ? attribute(errors, fname)|default(null) : null %}
            {% set ferrMsg = null %}
            {% if ferr is iterable %}
                {% set first = ferr|first %}
                {% if first is iterable %}
                    {% if attribute(first, 'key') is defined %}
                        {% set ferrMsg = __(first.key, attribute(first, 'params') is defined ? first.params : {}) %}
                    {% elseif attribute(first, 'code') is defined %}
                        {% set ferrMsg = __('validation.' ~ first.code) %}
                    {% elseif attribute(first, 'message') is defined %}
                        {% set ferrMsg = first.message %}
                    {% else %}
                        {% set ferrMsg = first|default('') %}
                    {% endif %}
                {% else %}
                    {% set ferrMsg = first %}
                {% endif %}
            {% else %}
                {% set ferrMsg = ferr %}
            {% endif %}
            <div class="form-control">
                <label class="label" for="{{ fname }}"><span class="label-text">{{ flabel }}{% if f.required %} *{% endif %}</span></label>
                {% if fname == 'picture' %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-start">
                        <div class="md:col-span-2 space-y-2">
                            <input class="input input-bordered w-full" id="{{ fname }}" name="{{ fname }}" type="text" value="{{ fval|e }}"{% if f.placeholder %} placeholder="{{ f.placeholder|e }}"{% endif %}{% if f.required %} required{% endif %}>
                            <small class="opacity-70">{{ __('You can paste an image URL or upload a file below.')|e }}</small>
                            {% if fval %}
                                <img class="mt-2 rounded border border-base-300 max-w-[120px] max-h-[120px] object-cover" src="{{ fval|e }}" alt="{{ __('Current picture')|e }}">
                            {% endif %}
                        </div>
                        <div>
                            <input class="file-input file-input-bordered w-full" name="picture_file" type="file" accept="image/*" data-upload="image" data-url-target="#picture">
                        </div>
                    </div>
                {% elseif ftype == 'textarea' %}
                    <textarea class="textarea textarea-bordered w-full" id="{{ fname }}" name="{{ fname }}" rows="{{ f.rows|default(4) }}"{% if f.required %} required{% endif %}>{{ fval|e }}</textarea>
                {% elseif ftype == 'select' %}
                    {% set cur = fval|default('') %}
                    <select class="select select-bordered w-full" id="{{ fname }}" name="{{ fname }}"{% if f.required %} required{% endif %}>
                        {% for key,label in f.options %}
                            <option value="{{ key|e }}" {{ cur == key ? 'selected' : '' }}>{{ label|e }}</option>
                        {% endfor %}
                    </select>
                {% elseif ftype == 'file' %}
                    <input class="file-input file-input-bordered w-full" id="{{ fname }}" name="{{ fname }}" type="file"{% if f.accept %} accept="{{ f.accept|e }}"{% endif %}{% if f.required %} required{% endif %}>
                {% else %}
                    {% if ftype == 'time' %}
                        <input class="input input-bordered w-full" id="{{ fname }}" name="{{ fname }}" type="time" step="1" value="{{ fval|e }}"{% if f.placeholder %} placeholder="{{ f.placeholder|e }}"{% endif %}{% if f.required %} required{% endif %}>
                    {% else %}
                        <input class="input input-bordered w-full" id="{{ fname }}" name="{{ fname }}" type="{{ ftype }}" value="{{ fval|e }}"{% if f.placeholder %} placeholder="{{ f.placeholder|e }}"{% endif %}{% if f.required %} required{% endif %}>
                    {% endif %}
                {% endif %}
                {% if ferrMsg %}
                    <div class="text-error text-sm mt-1">{{ ferrMsg|e }}</div>
                {% endif %}
            </div>
        {% endmacro %}
        {% import _self as self %}

        {% if prim or status %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Basics')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in prim %}{{ self.render_field(f, data, errors) }}{% endfor %}
                    {% for f in status %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if media %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Media')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in media %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if money or ids %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Numbers & IDs')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in money %}{{ self.render_field(f, data, errors) }}{% endfor %}
                    {% for f in ids %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if contacts %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Contacts & Links')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in contacts %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if dates %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Dates')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in dates %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if others %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body">
                <h3 class="card-title text-lg mb-2">{{ __('Details')|e }}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {% for f in others %}{{ self.render_field(f, data, errors) }}{% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        {% if texts %}
        <div class="card bg-base-100 border border-base-300">
            <div class="card-body space-y-4">
                <h3 class="card-title text-lg mb-2">{{ __('Notes')|e }}</h3>
                {% for f in texts %}{{ self.render_field(f, data, errors) }}{% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="flex items-center gap-2 justify-end">
            {% if cancel_url is defined and cancel_url %}
                <a class="btn" href="{{ cancel_url }}">{{ __('Cancel')|e }}</a>
            {% endif %}
            <button class="btn btn-primary" type="submit">{{ submit_label|default(__('Save')|e) }}</button>
        </div>
    </form>
    {% if hasFile %}
    <script>
    (function(){
      function findPreview(urlInput){
        // find an img preview near the URL input
        var wrap = urlInput.closest('.field') || document;
        var img = wrap.querySelector('img');
        return img;
      }
      async function uploadFile(input){
        const file = input.files && input.files[0];
        if(!file) return;
        const form = input.closest('form');
        const fd = new FormData();
        fd.append('file', file);
        const csrf = form ? form.querySelector('input[type="hidden"]') : null;
        const headers = {};
        if (csrf && csrf.value) headers['X-CSRF-Token'] = csrf.value;
        input.disabled = true;
        input.style.opacity = '0.6';
        try {
          const res = await fetch("{{ url('/upload') }}", { method: 'POST', body: fd, headers: headers });
          const data = await res.json();
          if(!res.ok || !data.ok){ throw new Error(data && data.error ? data.error : 'upload_failed'); }
          const targetSel = input.getAttribute('data-url-target');
          if (targetSel){
            const urlInput = form ? form.querySelector(targetSel) : document.querySelector(targetSel);
            if (urlInput){ urlInput.value = data.url; }
            const img = urlInput ? findPreview(urlInput) : null;
            if (img){ img.src = data.url; }
          }
        } catch (e) {
          alert('{{ __('Upload failed')|e }}: ' + (e && e.message ? e.message : e));
        } finally {
          input.disabled = false;
          input.style.opacity = '';
        }
      }
      document.addEventListener('change', function(ev){
        const el = ev.target;
        if (el && el.matches('input[type="file"][data-upload]')){
          uploadFile(el);
        }
      });
    })();
    </script>
    {% endif %}
</section>
