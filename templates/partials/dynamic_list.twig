{# Generic dynamic list renderer. Expects:
 - title (optional)
 - items: array of associative arrays
 - columns: array of {name,label}
 - actions: { edit_url: '/contacts/edit', delete_url: '/contacts/delete', id_field: 'id' } (optional)
 - path, page, per, total, q, sort, dir (optional for pagination/sorting UI; minimal rendering only)
#}
<section class="space-y-3">
    {% set listTitle = title|default('') %}
    {% if listTitle %}<h2 class="text-2xl font-semibold">{{ listTitle|e }}</h2>{% endif %}

    <div class="overflow-x-auto">
      {% if bulk is defined and bulk.post_url %}
      <form method="post" action="{{ bulk.post_url }}" id="bulkForm">
        {{ csrf_field()|raw }}
      {% endif %}
      <table class="table table-zebra w-full" aria-label="{{ listTitle ? listTitle|e : __('List')|e }}">
        {% if listTitle %}<caption class="sr-only">{{ listTitle|e }}</caption>{% endif %}
        <thead>
        <tr>
            {% if bulk is defined and bulk.post_url %}
                <th scope="col">
                    <input type="checkbox" id="bulkCheckAll" class="checkbox" onclick="(function(cb){var boxes=document.querySelectorAll('#bulkForm input[name=\'ids[]\']'); boxes.forEach(function(b){b.checked=cb.checked;});})(this)">
                </th>
            {% endif %}
            {% for col in columns %}
                {% set colName = col.name|default('') %}
                {% set isSorted = (sort|default('') == colName) %}
                {% set aria = isSorted ? (dir|default('asc') == 'asc' ? 'ascending' : 'descending') : 'none' %}
                <th scope="col" aria-sort="{{ aria }}">
                    {{ sort_link(col.label|default(colName), colName, sort|default(null), dir|default('asc'), path|default(current_path()), { q: q|default(''), tag: tag|default(''), per: per|default(10) })|raw }}
                </th>
            {% endfor %}
            {% if actions is defined and (actions.edit_url or actions.delete_url) %}
                <th scope="col">{{ __('Actions')|e }}</th>
            {% endif %}
        </tr>
        </thead>
        <tbody>
        {% if items|length == 0 %}
            <tr>
                <td class="text-center opacity-70" colspan="{{ columns|length + (actions is defined and (actions.edit_url or actions.delete_url) ? 1 : 0) + (bulk is defined and bulk.post_url ? 1 : 0) }}">{{ __('No records found')|e }}</td>
            </tr>
        {% else %}
            {% for it in items %}
                <tr>
                    {% if bulk is defined and bulk.post_url %}
                        {% set idf = actions.id_field|default('id') %}
                        {% set idv = attribute(it, idf)|default('') %}
                        <td><input type="checkbox" class="checkbox" name="ids[]" value="{{ idv|e }}" aria-label="{{ __('Select row')|e }}"></td>
                    {% endif %}
                    {% for col in columns %}
                        {% set value = attribute(it, col.name)|default('') %}
                        {% if loop.first and actions is defined and actions.view_url %}
                            {% set idf = actions.id_field|default('id') %}
                            {% set idv = attribute(it, idf)|default('') %}
                            <td>
                                {% if col.name in ['picture','image','avatar','photo'] and value %}
                                    <a href="{{ actions.view_url }}?id={{ idv|e }}" aria-label="{{ __('View details')|e }}">
                                        <img src="{{ value|e }}" alt="" class="w-9 h-9 rounded-full object-cover border border-base-300">
                                    </a>
                                {% else %}
                                    <a href="{{ actions.view_url }}?id={{ idv|e }}" class="link link-primary">{{ value|e }}</a>
                                {% endif %}
                            </td>
                        {% else %}
                            <td>
                                {% if col.name in ['picture','image','avatar','photo'] and value %}
                                    <img src="{{ value|e }}" alt="" class="w-9 h-9 rounded-full object-cover border border-base-300">
                                {% else %}
                                    {% if value is iterable %}
                                        <div class="flex flex-wrap gap-1">
                                            {% for t in value %}
                                                {% if t is iterable %}
                                                    {% for k,v in t %}
                                                        <span class="badge badge-ghost">{{ k|e }}: {{ v|e }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    {% if col.name == 'tags' %}
                                                        <a class="badge badge-ghost" href="{{ path|default(current_path())|e }}?tag={{ t|url_encode }}">{{ t|e }}</a>
                                                    {% else %}
                                                        <span class="badge badge-ghost">{{ t|e }}</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        {# Render links for URLs #}
                                        {% if value matches '/^https?:\\/\\//i' %}
                                            <a href="{{ value|e }}" target="_blank" rel="noopener" class="link">{{ value|e }}</a>
                                        {% else %}
                                            {{ value|e }}
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            </td>
                        {% endif %}
                    {% endfor %}
                    {% if actions is defined and (actions.edit_url or actions.delete_url) %}
                        {% set idf = actions.id_field|default('id') %}
                        {% set idv = attribute(it, idf)|default('') %}
                        <td class="whitespace-nowrap space-x-2">
                            {% if actions.edit_url %}
                                <a class="btn btn-xs" href="{{ actions.edit_url }}?id={{ idv|e }}" aria-label="{{ __('Edit')|e }}">{{ __('Edit')|e }}</a>
                            {% endif %}
                            {% if actions.delete_url %}
                                <form method="post" action="{{ actions.delete_url }}" class="inline" onsubmit="return confirm('{{ __('Are you sure?')|e }}');">
                                    {{ csrf_field()|raw }}
                                    <input type="hidden" name="id" value="{{ idv|e }}">
                                    <button class="btn btn-xs btn-error" type="submit" aria-label="{{ __('Delete')|e }}">{{ __('Delete')|e }}</button>
                                </form>
                            {% endif %}
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}
        {% endif %}
        </tbody>
      </table>
      {% if bulk is defined and bulk.post_url %}
      <div class="mt-3 flex flex-wrap items-center gap-2">
        <label for="bulkAction" class="sr-only">{{ __('Bulk action')|e }}</label>
        <select class="select select-bordered" id="bulkAction" name="action" onchange="(function(sel){var v=sel.value;var ph='';try{var map=JSON.parse(sel.dataset.placeholders||'{}');ph=map[v]||'';}catch(e){} var inp=document.getElementById('bulkValue'); if(inp){inp.placeholder=ph; inp.classList.toggle('hidden', ph==='');} })(this)" data-placeholders='{{ (bulk.placeholders|default({}))|json_encode|e }}'>
          <option value="">-- {{ __('Select action')|e }} --</option>
          {% for act in bulk.actions %}
            <option value="{{ act.value|e }}">{{ act.label|e }}</option>
          {% endfor %}
        </select>
        <input id="bulkValue" name="value" type="text" class="input input-bordered hidden" placeholder="">
        <button class="btn" type="submit" onclick="return (function(){var any=false; document.querySelectorAll('#bulkForm input[name=\'ids[]\']').forEach(function(b){ if(b.checked){ any=true; }}); if(!any){ alert('{{ __('Please select at least one item.')|e }}'); return false;} if(!document.getElementById('bulkAction').value){ alert('{{ __('Please select an action.')|e }}'); return false;} return confirm('{{ __('Are you sure?')|e }}'); })();">{{ __('Apply')|e }}</button>
      </div>
      </form>
      {% endif %}
    </div>
</section>
